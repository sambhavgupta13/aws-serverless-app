version: 0.2
phases:
  install:
      runtime-versions:
        nodejs: 18
      commands:
        - echo "Checking if dependencies need to be installed..."
        - |
          ls -la /root/.cache
          if [ -e "/root/.cache/dependencies-installed" ];then
          echo "dependencies already installed"
          else
          echo "Dependencies not installed, downloading from S3 cache";
          aws s3 cp s3://codebuild-artifacts-cache-sambhav/cb696437-0bb8-472a-a8e7-de9390b9ee99/ /root/.cache/ --recursive
          echo "Marking dependencies as installed..."
          touch /root/.cache/dependencies-installed
          echo installing dependencies
          node -v
          npm run install:frontend
          npm run install:server
          fi
  build:
    commands:
      - ls -la /root/.cache
      - echo $STAGE_NAME
      - chmod +x ./infrastructure/sam_dls.sh
      - |
        if [ "$STAGE_NAME" == "BUILD" ]; then
          echo "Running build-specific commands"
          ./infrastructure/sam_dls.sh build 
          ./infrastructure/sam_dls.sh package
        elif [ "$STAGE_NAME" == "DEPLOY" ]; then
          echo "Running deploy-specific commands"
          ./infrastructure/sam_dls.sh deploy 
        else
          echo "Unknown stage"
          exit 1
        fi

artifacts:
  files: 
    - '**/*'
  name: MyBuildArtifacts
  discard-paths: yes

cache:
  paths:
    - '/root/.cache'